<!DOCTYPE html>
<html lang="id">
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"
    />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- SEO Meta Tags -->
    <title>
      Supplier Gathering 2025 - Kuesioner & Konfirmasi Kehadiran | PT PLN
      Nusantara Power
    </title>
    <meta
      name="description"
      content="Form kuesioner dan konfirmasi kehadiran Supplier Gathering 2025 PT PLN Nusantara Power. Isi feedback kepuasan supplier untuk unit Paiton, Brantas, dan Pacitan. Acara 30 Oktober 2025 di Novotel Samator Surabaya."
    />
    <meta
      name="keywords"
      content="PLN Nusantara Power, Supplier Gathering 2025, Kuesioner Supplier, PT PLN NP, UP Paiton, UP Brantas, UP Pacitan"
    />
    <meta name="author" content="PT PLN Nusantara Power" />
    <meta name="robots" content="noindex, nofollow" />
    <link
      rel="canonical"
      href="https://script.google.com/macros/s/AKfycbyjIrwkM2lA8ov7qac0g2C-pLw8gcp-DO_xy-wTZ0Uigd7r-ijvNIhQv_SgLP5eIOy7/exec"
    />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://script.google.com/macros/s/AKfycbyjIrwkM2lA8ov7qac0g2C-pLw8gcp-DO_xy-wTZ0Uigd7r-ijvNIhQv_SgLP5eIOy7/exec"
    />
    <meta
      property="og:title"
      content="Supplier Gathering 2025 - PT PLN Nusantara Power"
    />
    <meta
      property="og:description"
      content="Form kuesioner kepuasan supplier PT PLN Nusantara Power 2025. Acara 30 Oktober 2025 di Novotel Samator Surabaya."
    />
    <meta property="og:locale" content="id_ID" />

    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "Event",
        "name": "Supplier Gathering 2025",
        "description": "Acara gathering dan kuesioner kepuasan supplier PT PLN Nusantara Power",
        "startDate": "2025-10-30T08:00:00+07:00",
        "endDate": "2025-10-30T17:00:00+07:00",
        "eventStatus": "https://schema.org/EventScheduled",
        "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
        "location": {
          "@type": "Place",
          "name": "Novotel Samator Surabaya",
          "address": {
            "@type": "PostalAddress",
            "streetAddress": "Jl. Raya Kedung Baruk No.26-28, Kedung Baruk, Kec. Rungkut",
            "addressLocality": "Surabaya",
            "addressRegion": "Jawa Timur",
            "postalCode": "60298",
            "addressCountry": "ID"
          }
        },
        "organizer": {
          "@type": "Organization",
          "name": "PT PLN Nusantara Power",
          "url": "https://www.plnnusantarapower.co.id"
        }
      }
    </script>

    <!-- Resource Hints for Performance -->
    <link rel="preconnect" href="https://script.google.com" />
    <link rel="dns-prefetch" href="https://script.google.com" />

    <style>
      /* Force responsive untuk Apps Script */
      html {
        width: 100%;
        -webkit-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
      }

      body {
        width: 100%;
        -webkit-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
        position: relative;
        min-height: 100vh;
      }

      /* Reset & Base Styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        line-height: 1.6;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        padding: 40px 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 10px;
        line-height: 1.4;
      }

      .header .subtitle {
        font-size: 14px;
        opacity: 0.9;
        margin-top: 8px;
      }

      .event-info {
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        padding: 20px 25px;
        margin: 30px;
        border-radius: 8px;
      }

      .event-info h3 {
        color: #1e3c72;
        font-size: 18px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .event-info-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 12px;
        font-size: 14px;
        color: #4a5568;
      }

      .event-info-item svg {
        flex-shrink: 0;
        margin-top: 2px;
      }

      .event-info-item strong {
        color: #2d3748;
        min-width: 80px;
      }

      .description {
        padding: 30px;
        color: #4a5568;
        font-size: 14px;
        line-height: 1.8;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
      }

      .rating-info {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 15px 20px;
        margin: 24px 30px 30px;
        border-radius: 8px;
      }

      .rating-info h4 {
        color: #856404;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .rating-scale {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }

      .rating-item {
        font-size: 13px;
        color: #856404;
      }

      .form-section {
        padding: 0 30px 30px;
      }

      .form-group {
        margin-bottom: 25px;
      }

      .form-label {
        display: block;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .required {
        color: #e53e3e;
        margin-left: 4px;
      }

      .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        font-family: inherit;
      }

      .form-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-input.error {
        border-color: #e53e3e;
      }

      .error-message {
        color: #e53e3e;
        font-size: 13px;
        margin-top: 6px;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      .radio-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .radio-option {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
      }

      .radio-option:hover {
        border-color: #667eea;
        background: #f7fafc;
      }

      .radio-option.selected {
        border-color: #667eea;
        background: #eef2ff;
      }

      .radio-option input[type="radio"],
      .radio-option input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-right: 12px;
        cursor: pointer;
        accent-color: #667eea;
      }

      .radio-option label {
        cursor: pointer;
        font-size: 14px;
        color: #2d3748;
        flex: 1;
      }

      .unit-note {
        font-size: 12px;
        color: #718096;
        margin-top: 8px;
        padding: 10px;
        background: #edf2f7;
        border-radius: 6px;
        line-height: 1.5;
      }

      .button-group {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 20px 30px;
        background: #f8f9fa;
        border-top: 1px solid #e2e8f0;
      }

      .btn {
        padding: 12px 32px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: inherit;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      @media (max-width: 640px) {
        body {
          padding: 10px;
        }

        .header {
          padding: 30px 20px;
        }

        .header h1 {
          font-size: 20px;
        }

        .event-info,
        .rating-info,
        .form-section {
          margin-left: 20px;
          margin-right: 20px;
          padding: 20px;
        }

        .rating-scale {
          grid-template-columns: 1fr;
        }

        .button-group {
          padding: 15px 20px;
        }

        .btn {
          width: 100%;
        }
      }

      /* Custom Searchable Dropdown */
      .company-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 300px;
        overflow-y: auto;
        background: white;
        border: 2px solid #667eea;
        border-top: none;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        margin-top: -8px;
      }

      .company-dropdown-item {
        padding: 12px 16px;
        cursor: pointer;
        transition: background 0.2s ease;
        border-bottom: 1px solid #f0f0f0;
      }

      .company-dropdown-item:last-child {
        border-bottom: none;
      }

      .company-dropdown-item:hover {
        background: #eef2ff;
      }

      .company-dropdown-item.active {
        background: #667eea;
        color: white;
      }

      .company-dropdown-empty {
        padding: 16px;
        text-align: center;
        color: #718096;
        font-size: 14px;
      }

      .company-dropdown-loading {
        padding: 16px;
        text-align: center;
        color: #667eea;
        font-size: 14px;
      }

      .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        align-items: center;
        justify-content: center;
      }

      .loading-overlay.show {
        display: flex;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Screen Reader Only */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
      }
    </style>
  </head>
  <body>
    <div
      class="loading-overlay"
      id="loadingOverlay"
      role="status"
      aria-live="polite"
      aria-label="Memuat data, mohon tunggu"
    >
      <div class="spinner" aria-hidden="true"></div>
      <span class="sr-only">Memuat...</span>
    </div>

    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>
          KUESIONER SUPPLIER & KONFIRMASI KEHADIRAN<br />SUPPLIER GATHERING 2025
        </h1>
        <div class="subtitle">PT PLN NUSANTARA POWER</div>
      </div>

      <!-- Event Information -->
      <div class="event-info">
        <h3>
          <svg
            width="20"
            height="20"
            fill="currentColor"
            viewBox="0 0 20 20"
            aria-hidden="true"
          >
            <path
              fill-rule="evenodd"
              d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
              clip-rule="evenodd"
            />
          </svg>
          Informasi Acara
        </h3>
        <div class="event-info-item">
          <svg
            width="18"
            height="18"
            fill="currentColor"
            viewBox="0 0 20 20"
            aria-hidden="true"
          >
            <path
              fill-rule="evenodd"
              d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
              clip-rule="evenodd"
            />
          </svg>
          <div>
            <strong>Waktu:</strong> Kamis, 30 Oktober 2025<br />08.00 WIB -
            Selesai
          </div>
        </div>
        <div class="event-info-item">
          <svg
            width="18"
            height="18"
            fill="currentColor"
            viewBox="0 0 20 20"
            aria-hidden="true"
          >
            <path
              fill-rule="evenodd"
              d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
              clip-rule="evenodd"
            />
          </svg>
          <div>
            <strong>Lokasi:</strong> Novotel Samator Surabaya<br />
            Jl. Raya Kedung Baruk No.26-28, Kedung Baruk, Kec. Rungkut,
            Surabaya, Jawa Timur 60298
          </div>
        </div>
        <div class="event-info-item">
          <svg
            width="18"
            height="18"
            fill="currentColor"
            viewBox="0 0 20 20"
            aria-hidden="true"
          >
            <path
              d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"
            />
          </svg>
          <div>
            <strong>Kontak:</strong><br />
            0822-5781-9900 (Fahmi Achmad)<br />
            0853-3545-8328 (Aminudin)
          </div>
        </div>
      </div>

      <!-- Description -->
      <div class="description">
        Dalam rangka untuk meningkatkan kualitas kemitraan antara para supplier
        dengan pihak PT PLN NUSANTARA POWER, maka kami perlu mendapatkan
        feedback dari para supplier yang akan kami manfaatkan untuk
        menilai/mengukur tingkat kepuasan dari para supplier terhadap pelayanan
        dan kinerja yang telah kami laksanakan. Hasil pengukuran ini akan kami
        jadikan masukan untuk peningkatkan pelayanan dan kinerja kami ke depan.
        Untuk itu mohon kesediaan para supplier untuk mengisi beberapa
        pertanyaan (Kuesioner) dari kami di bawah ini.
        <br /><br />
        <strong
          >Atas kesediaan dan partisipasi anda kami ucapkan terima
          kasih.</strong
        >
      </div>

      <!-- Rating Scale Info -->
      <div class="rating-info">
        <h4>KETERANGAN PENILAIAN:</h4>
        <div class="rating-scale">
          <div class="rating-item">1 = Tidak Puas</div>
          <div class="rating-item">2 = Cukup Puas</div>
          <div class="rating-item">3 = Puas</div>
          <div class="rating-item">4 = Sangat Puas</div>
        </div>
      </div>

      <!-- Form -->
      <form id="supplierForm" class="form-section">
        <!-- Email -->
        <div class="form-group">
          <label class="form-label">
            Email
            <span class="required">*</span>
          </label>
          <input
            type="email"
            name="email"
            class="form-input"
            placeholder="email@example.com"
            required
          />
          <div class="error-message" id="emailError">Email tidak valid</div>
          <div
            style="
              background: #fff3cd;
              border-left: 3px solid #ffc107;
              padding: 10px 12px;
              margin-top: 8px;
              border-radius: 4px;
              font-size: 13px;
              color: #856404;
              line-height: 1.5;
            "
          >
            <strong>⚠️ Penting:</strong> Pastikan alamat email Anda aktif untuk
            menerima <strong>QR Code</strong> yang digunakan untuk
            <strong>absensi kehadiran</strong> saat acara berlangsung.
          </div>
        </div>

        <!-- Nama Peserta -->
        <div class="form-group">
          <label class="form-label">
            Nama Peserta Undangan
            <span class="required">*</span>
          </label>
          <input
            type="text"
            name="nama"
            class="form-input"
            placeholder="Masukkan nama lengkap Anda"
            required
          />
          <div class="error-message" id="namaError">Nama wajib diisi</div>
        </div>

        <!-- Nama Perusahaan -->
        <div class="form-group">
          <label class="form-label">
            Nama Perusahaan
            <span class="required">*</span>
          </label>
          <div style="position: relative">
            <input
              type="text"
              name="namaPerusahaan"
              class="form-input"
              id="namaPerusahaanInput"
              placeholder="Ketik untuk mencari perusahaan..."
              autocomplete="off"
              required
            />
            <div
              id="companyDropdown"
              class="company-dropdown"
              style="display: none"
            ></div>
          </div>
          <div class="unit-note">
            Contoh Penulisan Nama Perusahaan (PT/CV PLN NUSANTARA POWER)<br />
            - Tanpa titik (.) atau koma (,)
            <br /><br />
            <strong>Catatan:</strong> Form ini hanya dapat diisi 1 kali per
            perusahaan. Jika nama perusahaan Anda tidak ada dalam daftar,
            berarti perusahaan tersebut sudah mengisi kuesioner.
          </div>
          <div class="error-message" id="namaPerusahaanError">
            Nama perusahaan wajib dipilih
          </div>
        </div>

        <!-- Jabatan -->
        <div class="form-group">
          <label class="form-label">
            Jabatan dalam Perusahaan
            <span class="required">*</span>
          </label>
          <input
            type="text"
            name="jabatan"
            class="form-input"
            placeholder="Masukkan jabatan Anda"
            required
          />
          <div class="error-message" id="jabatanError">Jabatan wajib diisi</div>
        </div>

        <!-- Unit Pembangkit -->
        <div class="form-group">
          <label class="form-label">
            Pilih Unit Pembangkit
            <span class="required">*</span>
          </label>
          <div class="radio-group" id="unitPembangkit">
            <div class="radio-option">
              <input
                type="checkbox"
                name="unit"
                value="UP PAITON"
                id="paiton"
              />
              <label for="paiton">UP PAITON</label>
            </div>
            <div class="radio-option">
              <input
                type="checkbox"
                name="unit"
                value="UP BRANTAS"
                id="brantas"
              />
              <label for="brantas">UP BRANTAS</label>
            </div>
            <div class="radio-option">
              <input
                type="checkbox"
                name="unit"
                value="UP PACITAN"
                id="pacitan"
              />
              <label for="pacitan">UP PACITAN</label>
            </div>
          </div>
          <div class="unit-note">
            <strong>Catatan:</strong> Anda dapat memilih lebih dari satu unit
            pembangkit jika Anda mewakili beberapa unit sekaligus.
          </div>
          <div class="error-message" id="unitError">
            Pilih minimal satu unit pembangkit
          </div>
        </div>

        <!-- Konfirmasi Kehadiran -->
        <div class="form-group">
          <label class="form-label">
            Apakah Anda bersedia hadir dalam acara Supplier Gathering 2025?
            <span class="required">*</span>
          </label>
          <div class="radio-group" id="kehadiran">
            <div class="radio-option">
              <input type="radio" name="kehadiran" value="Ya" id="hadir_ya" />
              <label for="hadir_ya">Ya, saya akan hadir</label>
            </div>
            <div class="radio-option">
              <input
                type="radio"
                name="kehadiran"
                value="Tidak"
                id="hadir_tidak"
              />
              <label for="hadir_tidak">Tidak, saya tidak dapat hadir</label>
            </div>
          </div>
          <div class="error-message" id="kehadiranError">
            Pilih konfirmasi kehadiran
          </div>
        </div>
      </form>

      <!-- Navigation Buttons -->
      <div class="button-group">
        <button type="button" class="btn btn-primary" onclick="handleNext()">
          Selanjutnya
        </button>
      </div>
    </div>

    <script>
      // Store available companies globally for validation
      let availableCompanies = [];
      let selectedCompanyIndex = -1;

      // Load available companies on page load (with localStorage cache)
      (function loadAvailableCompanies() {
        console.log("Loading available companies...");

        const dropdown = document.getElementById("companyDropdown");
        const CACHE_KEY = "available_companies_cache";
        const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

        // Try to load from localStorage first
        try {
          const cached = localStorage.getItem(CACHE_KEY);
          if (cached) {
            const data = JSON.parse(cached);
            if (Date.now() - data.timestamp < CACHE_TTL) {
              console.log("Using cached companies:", data.companies.length);
              availableCompanies = data.companies;
              setupCompanySearch();
              loadSavedData();
              return; // Skip server call
            }
          }
        } catch (e) {
          console.log("Cache read error:", e);
        }

        // Cache miss or expired - load from server
        dropdown.innerHTML =
          '<div class="company-dropdown-loading">Memuat daftar perusahaan...</div>';
        dropdown.style.display = "block";

        // Call Google Apps Script function
        google.script.run
          .withSuccessHandler(function (companies) {
            console.log("Available companies loaded:", companies.length);

            // Store globally
            availableCompanies = companies;

            // Cache to localStorage
            try {
              localStorage.setItem(
                CACHE_KEY,
                JSON.stringify({ companies: companies, timestamp: Date.now() })
              );
            } catch (e) {
              console.log("Cache write error:", e);
            }

            // Hide loading
            dropdown.style.display = "none";

            // Setup search functionality
            setupCompanySearch();

            // Load saved data
            loadSavedData();
          })
          .withFailureHandler(function (error) {
            console.error("Error loading companies:", error);
            dropdown.innerHTML =
              '<div class="company-dropdown-empty">Error loading companies. Please refresh page.</div>';
          })
          .getAvailableCompanies();
      })();

      // Setup custom searchable dropdown
      function setupCompanySearch() {
        const input = document.getElementById("namaPerusahaanInput");
        const dropdown = document.getElementById("companyDropdown");

        // Debounce helper
        let debounceTimer;
        function debounce(func, delay) {
          return function () {
            const context = this;
            const args = arguments;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => func.apply(context, args), delay);
          };
        }

        // Show dropdown on focus
        input.addEventListener("focus", function () {
          if (availableCompanies.length > 0) {
            filterCompanies(this.value);
          }
        });

        // Filter on input (debounced 200ms untuk mengurangi DOM manipulation)
        input.addEventListener(
          "input",
          debounce(function () {
            filterCompanies(this.value);
          }, 200)
        );

        // Keyboard navigation
        input.addEventListener("keydown", function (e) {
          const items = dropdown.querySelectorAll(".company-dropdown-item");

          if (e.key === "ArrowDown") {
            e.preventDefault();
            selectedCompanyIndex = Math.min(
              selectedCompanyIndex + 1,
              items.length - 1
            );
            updateActiveItem(items);
          } else if (e.key === "ArrowUp") {
            e.preventDefault();
            selectedCompanyIndex = Math.max(selectedCompanyIndex - 1, 0);
            updateActiveItem(items);
          } else if (e.key === "Enter") {
            e.preventDefault();
            if (selectedCompanyIndex >= 0 && items[selectedCompanyIndex]) {
              items[selectedCompanyIndex].click();
            }
          } else if (e.key === "Escape") {
            dropdown.style.display = "none";
          }
        });

        // Hide dropdown when clicking outside
        document.addEventListener("click", function (e) {
          if (!input.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = "none";
          }
        });
      }

      function filterCompanies(searchTerm) {
        const dropdown = document.getElementById("companyDropdown");
        const input = document.getElementById("namaPerusahaanInput");

        // Filter companies based on search term (case insensitive)
        const filtered = availableCompanies.filter((company) =>
          company.toLowerCase().includes(searchTerm.toLowerCase())
        );

        // Reset selection
        selectedCompanyIndex = -1;

        if (filtered.length === 0) {
          dropdown.innerHTML =
            '<div class="company-dropdown-empty">Tidak ada perusahaan yang cocok dengan pencarian "' +
            searchTerm +
            '"</div>';
          dropdown.style.display = "block";
          return;
        }

        // Build dropdown HTML
        dropdown.innerHTML = filtered
          .map((company, index) => {
            // Highlight matching text
            const regex = new RegExp("(" + searchTerm + ")", "gi");
            const highlighted = company.replace(regex, "<strong>$1</strong>");
            return (
              '<div class="company-dropdown-item" data-company="' +
              company +
              '" data-index="' +
              index +
              '">' +
              highlighted +
              "</div>"
            );
          })
          .join("");

        // Add click handlers
        dropdown.querySelectorAll(".company-dropdown-item").forEach((item) => {
          item.addEventListener("click", function () {
            input.value = this.dataset.company;
            dropdown.style.display = "none";
            input.classList.remove("error");

            // Remove error if any
            const errorElement = document.getElementById("namaPerusahaanError");
            if (errorElement) errorElement.classList.remove("show");
          });
        });

        dropdown.style.display = "block";
      }

      function updateActiveItem(items) {
        items.forEach((item, index) => {
          if (index === selectedCompanyIndex) {
            item.classList.add("active");
            item.scrollIntoView({ block: "nearest" });
          } else {
            item.classList.remove("active");
          }
        });
      }

      // Load saved data from localStorage
      function loadSavedData() {
        const savedData = localStorage.getItem("step1Data");
        if (savedData) {
          try {
            const data = JSON.parse(savedData);

            // Fill inputs
            if (data.namaPerusahaan) {
              const inputElement = document.querySelector(
                '[name="namaPerusahaan"]'
              );
              // Check if the saved company is still available
              if (availableCompanies.includes(data.namaPerusahaan)) {
                inputElement.value = data.namaPerusahaan;
              }
            }
            if (data.email)
              document.querySelector('[name="email"]').value = data.email;
            if (data.nama)
              document.querySelector('[name="nama"]').value = data.nama;
            if (data.jabatan)
              document.querySelector('[name="jabatan"]').value = data.jabatan;

            // Check units
            if (data.units && Array.isArray(data.units)) {
              data.units.forEach((unit) => {
                const checkbox = document.querySelector(
                  `input[name="unit"][value="${unit}"]`
                );
                if (checkbox) {
                  checkbox.checked = true;
                  checkbox.closest(".radio-option").classList.add("selected");
                }
              });
            }

            // Check kehadiran
            if (data.kehadiran) {
              const radio = document.querySelector(
                `input[name="kehadiran"][value="${data.kehadiran}"]`
              );
              if (radio) {
                radio.checked = true;
                radio.closest(".radio-option").classList.add("selected");
              }
            }
          } catch (e) {
            console.log("Error loading saved data:", e);
          }
        }
      }

      // Add selected class to radio options
      document
        .querySelectorAll('.radio-option input[type="radio"]')
        .forEach((radio) => {
          radio.addEventListener("change", function () {
            const groupName = this.name;
            document
              .querySelectorAll(`input[name="${groupName}"]`)
              .forEach((r) => {
                r.closest(".radio-option").classList.remove("selected");
              });
            this.closest(".radio-option").classList.add("selected");
          });
        });

      // Add selected class to checkbox options
      document
        .querySelectorAll('.radio-option input[type="checkbox"]')
        .forEach((checkbox) => {
          checkbox.addEventListener("change", function () {
            if (this.checked) {
              this.closest(".radio-option").classList.add("selected");
            } else {
              this.closest(".radio-option").classList.remove("selected");
            }
          });
        });

      // Form validation
      function validateForm() {
        let isValid = true;

        // Nama Perusahaan validation (input with datalist)
        const namaPerusahaan = document.querySelector(
          'input[name="namaPerusahaan"]'
        );
        const namaPerusahaanError = document.getElementById(
          "namaPerusahaanError"
        );

        if (
          !namaPerusahaan ||
          !namaPerusahaan.value ||
          namaPerusahaan.value.trim() === ""
        ) {
          if (namaPerusahaan) namaPerusahaan.classList.add("error");
          if (namaPerusahaanError) {
            namaPerusahaanError.textContent = "Nama perusahaan wajib dipilih";
            namaPerusahaanError.classList.add("show");
          }
          isValid = false;
        } else if (!availableCompanies.includes(namaPerusahaan.value)) {
          // Validate that user selected from the available list
          namaPerusahaan.classList.add("error");
          if (namaPerusahaanError) {
            namaPerusahaanError.textContent =
              "Pilih perusahaan dari daftar yang tersedia. Perusahaan ini tidak tersedia atau sudah mengisi kuesioner.";
            namaPerusahaanError.classList.add("show");
          }
          isValid = false;
        } else {
          namaPerusahaan.classList.remove("error");
          if (namaPerusahaanError) namaPerusahaanError.classList.remove("show");
        }

        // Email validation
        const email = document.querySelector('input[name="email"]');
        const emailError = document.getElementById("emailError");
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (!email.value.trim() || !emailRegex.test(email.value)) {
          email.classList.add("error");
          emailError.classList.add("show");
          isValid = false;
        } else {
          email.classList.remove("error");
          emailError.classList.remove("show");
        }

        // Nama validation
        const nama = document.querySelector('input[name="nama"]');
        const namaError = document.getElementById("namaError");

        if (!nama.value.trim()) {
          nama.classList.add("error");
          namaError.classList.add("show");
          isValid = false;
        } else {
          nama.classList.remove("error");
          namaError.classList.remove("show");
        }

        // Jabatan validation
        const jabatan = document.querySelector('input[name="jabatan"]');
        const jabatanError = document.getElementById("jabatanError");

        if (!jabatan.value.trim()) {
          jabatan.classList.add("error");
          jabatanError.classList.add("show");
          isValid = false;
        } else {
          jabatan.classList.remove("error");
          jabatanError.classList.remove("show");
        }

        // Unit validation (checkbox - at least one must be selected)
        const units = document.querySelectorAll('input[name="unit"]:checked');
        const unitError = document.getElementById("unitError");

        if (units.length === 0) {
          unitError.classList.add("show");
          isValid = false;
        } else {
          unitError.classList.remove("show");
        }

        // Kehadiran validation
        const kehadiran = document.querySelector(
          'input[name="kehadiran"]:checked'
        );
        const kehadiranError = document.getElementById("kehadiranError");

        if (!kehadiran) {
          kehadiranError.classList.add("show");
          isValid = false;
        } else {
          kehadiranError.classList.remove("show");
        }

        return isValid;
      }

      // Handle next button
      function handleNext() {
        if (validateForm()) {
          // Get selected units (multiple selection)
          const selectedUnits = Array.from(
            document.querySelectorAll('input[name="unit"]:checked')
          ).map((checkbox) => checkbox.value);

          const formData = {
            namaPerusahaan: document.querySelector(
              'input[name="namaPerusahaan"]'
            ).value,
            email: document.querySelector('input[name="email"]').value,
            nama: document.querySelector('input[name="nama"]').value,
            jabatan: document.querySelector('input[name="jabatan"]').value,
            units: selectedUnits, // Array of selected units
            kehadiran: document.querySelector('input[name="kehadiran"]:checked')
              .value,
          };

          // Save to local storage (persistent)
          localStorage.setItem("step1Data", JSON.stringify(formData));
          
          // Debug: log to console
          console.log("Step1 data saved to localStorage:", formData);

          // Show loading overlay for user feedback
          document.getElementById("loadingOverlay").classList.add("show");

          // Navigate to step 2 by reloading iframe with query parameter
          setTimeout(() => {
            console.log("=== NAVIGATION DEBUG ===");
            console.log("Current URL:", window.location.href);
            console.log("localStorage step1Data:", localStorage.getItem('step1Data'));
            console.log("Navigating to step2...");
            
            // Reload iframe with ?page=step2 (stays within iframe, no sandbox issue)
            window.location.href = '?page=step2';
          }, 500);
        } else {
          const firstError = document.querySelector(
            ".error, .error-message.show"
          );
          if (firstError) {
            firstError.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        }
      }

      // Remove error styling on input
      document.querySelectorAll(".form-input").forEach((input) => {
        input.addEventListener("input", function () {
          this.classList.remove("error");
          const errorId = this.name + "Error";
          const errorElement = document.getElementById(errorId);
          if (errorElement) {
            errorElement.classList.remove("show");
          }
        });
      });

      // ============================================================
      // AUTO-RESTORE DATA FROM LOCALSTORAGE (When user clicks "Kembali" from Step 2)
      // ============================================================
      (function restoreSavedData() {
        try {
          // Check if there's saved data in localStorage
          const savedDataJson = localStorage.getItem("step1Data");

          if (savedDataJson) {
            const savedData = JSON.parse(savedDataJson);

            // Restore text inputs
            if (savedData.namaPerusahaan) {
              const namaPerusahaan = document.querySelector(
                'input[name="namaPerusahaan"]'
              );
              if (namaPerusahaan)
                namaPerusahaan.value = savedData.namaPerusahaan;
            }

            if (savedData.email) {
              const email = document.querySelector('input[name="email"]');
              if (email) email.value = savedData.email;
            }

            if (savedData.nama) {
              const nama = document.querySelector('input[name="nama"]');
              if (nama) nama.value = savedData.nama;
            }

            if (savedData.jabatan) {
              const jabatan = document.querySelector('input[name="jabatan"]');
              if (jabatan) jabatan.value = savedData.jabatan;
            }

            // Restore unit checkboxes (multiple selection)
            if (savedData.units && Array.isArray(savedData.units)) {
              savedData.units.forEach((unitValue) => {
                const checkbox = document.querySelector(
                  `input[name="unit"][value="${unitValue}"]`
                );
                if (checkbox) {
                  checkbox.checked = true;
                  // Add selected styling
                  const radioOption = checkbox.closest(".radio-option");
                  if (radioOption) {
                    radioOption.classList.add("selected");
                  }
                }
              });
            }

            // Restore kehadiran radio button
            if (savedData.kehadiran) {
              const kehadiranRadio = document.querySelector(
                `input[name="kehadiran"][value="${savedData.kehadiran}"]`
              );
              if (kehadiranRadio) {
                kehadiranRadio.checked = true;
                // Add selected styling
                const radioOption = kehadiranRadio.closest(".radio-option");
                if (radioOption) {
                  radioOption.classList.add("selected");
                }
              }
            }

            console.log("✅ Data step1 berhasil di-restore dari localStorage");
          }
        } catch (error) {
          console.log("⚠️ Error restoring data:", error);
          // Don't alert user, just log the error silently
        }
      })();
    </script>
  </body>
</html>
